<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公交时刻表查询系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 保持原有的CSS样式不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 12px;
            color: #333;
            line-height: 1.5;
        }
        
        /* 保持其余CSS样式不变... */
        
    </style>
</head>

<body>
    <div class="container">
        <!-- 数据加载指示器 -->
        <div class="loader" id="loader">
            <div class="loader-spinner"></div>
            <p>正在加载公交数据...</p>
        </div>

        <!-- 保持原有的HTML结构不变... -->

    </div>

    <script>
        // 1. 全局变量声明
        let busSchedules = null;
        let currentLine = "";
        let currentDirection = "up";
        let isDataLoaded = false;

        // 2. DOM元素引用
        const loader = document.getElementById('loader');
        const busNumberInput = document.getElementById('busNumber');
        const searchBtn = document.getElementById('searchBtn');
        const resultContainer = document.getElementById('resultContainer');
        const infoText = document.getElementById('infoText');
        const lineBadge = document.getElementById('lineBadge');
        const lineName = document.getElementById('lineName');
        const lineRoute = document.getElementById('lineRoute');
        const nextTime = document.getElementById('nextTime');
        const scheduleGrid = document.getElementById('scheduleGrid');
        const currentTimeEl = document.getElementById('currentTime');
        const directionSwitch = document.getElementById('directionSwitch');
        const dirButtons = document.querySelectorAll('.dir-btn');
        const exampleLines = document.getElementById('exampleLines');
        const dataStatus = document.getElementById('dataStatus');

        // 3. 工具函数
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            currentTimeEl.textContent = `${hours}:${minutes}`;
            return now;
        }

        function setLoading(state) {
            if (state) {
                loader.style.display = 'flex';
                loader.style.opacity = '1';
                searchBtn.disabled = true;
            } else {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    searchBtn.disabled = false;
                }, 300);
            }
        }

        function showError(message) {
            infoText.innerHTML = `
                <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i>
                <p>${message}</p>
            `;
            infoText.style.display = 'block';
            resultContainer.style.display = 'none';
            directionSwitch.style.display = 'none';
        }

        // 4. 核心功能函数
        async function loadBusData() {
            try {
                setLoading(true);
                dataStatus.textContent = "正在加载公交数据...";
                
                const response = await fetch('https://klq6101g.github.io/ntbus/bustime.json')
');
                if (!response.ok) {
                    throw new Error(`数据加载失败: ${response.status}`);
                }
                
                busSchedules = await response.json();
                
                if (!busSchedules || Object.keys(busSchedules).length === 0) {
                    throw new Error("公交数据为空");
                }
                
                isDataLoaded = true;
                dataStatus.textContent = `已加载 ${Object.keys(busSchedules).length} 条公交线路数据`;
                generateExampleLines();
                
            } catch (error) {
                console.error('加载公交数据失败:', error);
                dataStatus.textContent = "数据加载失败";
                loader.innerHTML = `
                    <div style="text-align: center; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                        <p>加载公交数据失败</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">${error.message}</p>
                        <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 15px; background: #1a2980; color: white; border: none; border-radius: 8px;">重新加载</button>
                    </div>
                `;
                busSchedules = {}; // 设置为空对象避免后续错误
            } finally {
                setLoading(false);
            }
        }

        function generateExampleLines() {
            if (!busSchedules) return;
            
            exampleLines.innerHTML = '';
            const lines = Object.keys(busSchedules).slice(0, 8);
            
            lines.forEach(line => {
                const tag = document.createElement('div');
                tag.className = 'line-tag';
                tag.textContent = line;
                tag.addEventListener('click', () => {
                    busNumberInput.value = line;
                    searchLine(line);
                });
                exampleLines.appendChild(tag);
            });
        }

        function findNextDeparture(schedule) {
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTotalMinutes = currentHours * 60 + currentMinutes;
            
            // 查找今天剩余时间的班次
            for (const time of schedule) {
                const [hours, minutes] = time.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes;
                
                if (totalMinutes >= currentTotalMinutes) {
                    return time;
                }
            }
            
            // 如果没有找到，返回明天的第一个班次
            return schedule[0];
        }

        function displaySchedule(line, direction) {
            if (!isDataLoaded) {
                showError("公交数据尚未加载完成，请稍后再试");
                return;
            }
            
            const lineData = busSchedules[line];
            if (!lineData) {
                showError(`未找到线路 "${line}" 的时刻表信息`);
                return;
            }
            
            const directionData = lineData[direction];
            if (!directionData || !directionData.schedule) {
                showError(`未找到线路 "${line}" ${direction === 'up' ? '上行' : '下行'}时刻表`);
                return;
            }

            // 更新线路信息
            lineBadge.textContent = line;
            lineName.textContent = lineData.name || line;
            lineRoute.textContent = directionData.route || `${line}路${direction === 'up' ? '上行' : '下行'}线路`;

            // 更新最近发车时间
            const nextDeparture = findNextDeparture(directionData.schedule);
            nextTime.textContent = nextDeparture;

            // 生成时刻表
            scheduleGrid.innerHTML = '';
            const now = updateCurrentTime();
            const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
            
            directionData.schedule.forEach(time => {
                const [hours, minutes] = time.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes;
                
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = time;
                
                if (totalMinutes < currentTotalMinutes) {
                    timeSlot.classList.add('past');
                }
                
                if (time === nextDeparture) {
                    timeSlot.classList.add('next');
                }
                
                scheduleGrid.appendChild(timeSlot);
            });

            // 显示结果
            resultContainer.style.display = 'block';
            infoText.style.display = 'none';
            directionSwitch.style.display = 'flex';
            
            // 更新当前状态
            currentLine = line;
            currentDirection = direction;
        }

        function searchLine(line) {
            if (!line || !line.trim()) {
                showError("请输入公交线路号");
                return;
            }
            
            displaySchedule(line.trim(), 'up');
            
            // 重置方向按钮状态
            dirButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.dir === 'up');
            });
        }

        // 5. 事件监听
        function setupEventListeners() {
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', () => {
                searchLine(busNumberInput.value);
            });

            // 方向切换按钮事件
            dirButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentLine) {
                        const dir = button.dataset.dir;
                        displaySchedule(currentLine, dir);
                        
                        // 更新按钮激活状态
                        dirButtons.forEach(btn => {
                            btn.classList.toggle('active', btn === button);
                        });
                    }
                });
            });

            // 输入框回车事件
            busNumberInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }

        // 6. 初始化
        async function initialize() {
            // 初始化显示状态
            infoText.style.display = 'block';
            resultContainer.style.display = 'none';
            directionSwitch.style.display = 'none';
            
            // 启动时间更新
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 设置事件监听
            setupEventListeners();
            
            // 加载数据
            await loadBusData();
        }

        // 启动应用
        initialize();
    </script>
</body>

</html>
